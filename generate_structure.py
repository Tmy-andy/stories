#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Script to generate project folder structure
Táº¡o cáº¥u trÃºc thÆ° má»¥c dá»± Ã¡n thÃ nh file text
"""

import os
import sys
from pathlib import Path

def should_ignore(path, ignore_patterns):
    """Kiá»ƒm tra xem file/folder cÃ³ nÃªn bá» qua khÃ´ng"""
    path_str = str(path)
    for pattern in ignore_patterns:
        if pattern in path_str:
            return True
    return False

def get_tree(directory, prefix="", ignore_patterns=None, max_depth=None, current_depth=0):
    """
    Táº¡o cáº¥u trÃºc cÃ¢y thÆ° má»¥c
    
    Args:
        directory: ÄÆ°á»ng dáº«n thÆ° má»¥c cáº§n duyá»‡t
        prefix: Tiá»n tá»‘ hiá»ƒn thá»‹ (dÃ¹ng cho cÃ¢y)
        ignore_patterns: Danh sÃ¡ch pattern cáº§n bá» qua
        max_depth: Äá»™ sÃ¢u tá»‘i Ä‘a (None = khÃ´ng giá»›i háº¡n)
        current_depth: Äá»™ sÃ¢u hiá»‡n táº¡i
    
    Returns:
        String chá»©a cáº¥u trÃºc cÃ¢y
    """
    if ignore_patterns is None:
        ignore_patterns = [
            'node_modules',
            '.git',
            '__pycache__',
            '.env',
            '.DS_Store',
            'Thumbs.db',
            '.vscode',
            '.idea',
            'dist',
            'build',
            '.next',
            '.cache',
            'z-demo',
            'z_demo',
            '.html',
            '.zip'
        ]
    
    # Kiá»ƒm tra Ä‘á»™ sÃ¢u
    if max_depth is not None and current_depth >= max_depth:
        return ""
    
    tree_str = ""
    
    try:
        entries = sorted(os.listdir(directory))
    except PermissionError:
        return f"{prefix}[Permission Denied]\n"
    
    # Lá»c entries
    entries = [e for e in entries if not should_ignore(
        os.path.join(directory, e), ignore_patterns
    )]
    
    for i, entry in enumerate(entries):
        path = os.path.join(directory, entry)
        is_last = i == len(entries) - 1
        current_prefix = "â””â”€â”€ " if is_last else "â”œâ”€â”€ "
        next_prefix = prefix + ("    " if is_last else "â”‚   ")
        
        if os.path.isdir(path):
            tree_str += f"{prefix}{current_prefix}{entry}/\n"
            tree_str += get_tree(path, next_prefix, ignore_patterns, max_depth, current_depth + 1)
        else:
            tree_str += f"{prefix}{current_prefix}{entry}\n"
    
    return tree_str

def count_files_and_folders(directory, ignore_patterns=None):
    """Äáº¿m sá»‘ file vÃ  folder"""
    if ignore_patterns is None:
        ignore_patterns = [
            'node_modules',
            '.git',
            '__pycache__',
            '.env',
            '.DS_Store',
            'Thumbs.db',
            '.vscode',
            '.idea',
            'dist',
            'build',
            '.next',
            '.cache',
            'z-demo',
            'z_demo',
            '.html',
            '.zip'
        ]
    
    files = 0
    folders = 0
    
    for root, dirs, file_list in os.walk(directory):
        # Lá»c directories
        dirs[:] = [d for d in dirs if not should_ignore(
            os.path.join(root, d), ignore_patterns
        )]
        
        # Lá»c files
        for file in file_list:
            if not should_ignore(os.path.join(root, file), ignore_patterns):
                files += 1
        
        folders += len(dirs)
    
    return files, folders

def generate_structure(project_path, output_file=None, max_depth=None):
    """
    Táº¡o file cáº¥u trÃºc dá»± Ã¡n
    
    Args:
        project_path: ÄÆ°á»ng dáº«n dá»± Ã¡n
        output_file: File output (None = in ra console)
        max_depth: Äá»™ sÃ¢u tá»‘i Ä‘a
    """
    
    if not os.path.exists(project_path):
        print(f"âŒ Error: ÄÆ°á»ng dáº«n '{project_path}' khÃ´ng tá»“n táº¡i!")
        return False
    
    if not os.path.isdir(project_path):
        print(f"âŒ Error: '{project_path}' khÃ´ng pháº£i thÆ° má»¥c!")
        return False
    
    project_name = os.path.basename(project_path) or project_path
    
    print(f"ğŸ“ Äang táº¡o cáº¥u trÃºc cho: {project_name}")
    print(f"ğŸ“ ÄÆ°á»ng dáº«n: {project_path}")
    
    # Äáº¿m file vÃ  folder
    file_count, folder_count = count_files_and_folders(project_path)
    
    # Táº¡o chuá»—i cáº¥u trÃºc
    structure = f"{project_name}/\n"
    structure += get_tree(project_path, "", max_depth=max_depth)
    
    # Táº¡o ná»™i dung Ä‘áº§y Ä‘á»§
    content = f"""# PROJECT STRUCTURE
# Cáº¥u trÃºc thÆ° má»¥c dá»± Ã¡n
# Generated by generate_structure.py

Project: {project_name}
Path: {project_path}
Date: {os.popen('date').read().strip() if sys.platform != 'win32' else 'N/A'}

Statistics / Thá»‘ng kÃª:
- Folders / ThÆ° má»¥c: {folder_count}
- Files / File: {file_count}

Ignored Patterns / CÃ¡c pattern bá»‹ bá» qua:
- node_modules/
- .git/
- __pycache__/
- .env
- .DS_Store
- Thumbs.db
- .vscode/
- .idea/
- dist/
- build/
- .next/
- .cache/
- z-demo/
- z_demo/
- *.html (demo files)
- *.zip

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

STRUCTURE / Cáº¤U TRÃšC:

{structure}

â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
"""
    
    # Output
    if output_file:
        output_path = os.path.join(project_path, output_file)
        try:
            with open(output_path, 'w', encoding='utf-8') as f:
                f.write(content)
            print(f"âœ… File táº¡o thÃ nh cÃ´ng: {output_path}")
            return True
        except Exception as e:
            print(f"âŒ Error khi táº¡o file: {e}")
            return False
    else:
        print(content)
        return True

def main():
    """HÃ m chÃ­nh"""
    print("""
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘         PROJECT STRUCTURE GENERATOR / Táº O Cáº¤U TRÃšC Dá»° ÃN      â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
    """)
    
    # Láº¥y input tá»« user
    if len(sys.argv) > 1:
        project_path = sys.argv[1]
    else:
        project_path = input("ğŸ“‚ Nháº­p Ä‘Æ°á»ng dáº«n dá»± Ã¡n: ").strip()
        if not project_path:
            project_path = "."
    
    # Normalize path
    project_path = os.path.abspath(project_path)
    
    # Chá»n output
    print("\nğŸ“ Lá»±a chá»n cÃ¡ch lÆ°u:")
    print("1. LÆ°u vÃ o file STRUCTURE.txt")
    print("2. In ra console (terminal)")
    
    choice = input("Chá»n (1 hoáº·c 2): ").strip()
    
    output_file = None
    if choice == "1":
        output_file = "STRUCTURE.txt"
    
    # Chá»n Ä‘á»™ sÃ¢u
    print("\nğŸ” Äá»™ sÃ¢u tÃ¬m kiáº¿m:")
    print("1. KhÃ´ng giá»›i háº¡n (táº¥t cáº£)")
    print("2. 2 cáº¥p")
    print("3. 3 cáº¥p")
    print("4. 4 cáº¥p")
    print("5. 5 cáº¥p")
    
    depth_choice = input("Chá»n (1-5): ").strip()
    max_depth = None
    if depth_choice in ["2", "3", "4", "5"]:
        max_depth = int(depth_choice)
    
    # Táº¡o cáº¥u trÃºc
    success = generate_structure(project_path, output_file, max_depth)
    
    if success:
        print("\nâœ¨ ThÃ nh cÃ´ng!")
        if output_file:
            print(f"ğŸ’¾ File Ä‘Æ°á»£c lÆ°u táº¡i: {os.path.join(project_path, output_file)}")
    else:
        print("\nâŒ CÃ³ lá»—i xáº£y ra!")
        sys.exit(1)

if __name__ == "__main__":
    main()